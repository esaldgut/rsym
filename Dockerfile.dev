# Dockerfile OPTIMIZADO - Sin node_modules del host
FROM node:20-alpine

RUN apk add --no-cache libc6-compat git

WORKDIR /app

# IMPORTANTE: Copiar package files PRIMERO
COPY package.json yarn.lock ./

# Instalar dependencias ANTES de copiar código
# Esto crea node_modules LIMPIO dentro del contenedor
RUN yarn install --frozen-lockfile && \
    yarn cache clean

# AHORA copiar código fuente (sin node_modules gracias a .dockerignore)
# Usamos COPY individual para evitar copiar basura
COPY src ./src
COPY public ./public
COPY amplify ./amplify
COPY tsconfig.json ./
COPY next.config.mjs ./
COPY postcss.config.mjs ./
COPY next-env.d.ts ./
COPY middleware.ts ./

# Variables de entorno
ENV NODE_ENV=development
ENV NEXT_TELEMETRY_DISABLED=1
ENV PORT=3000
ENV HOSTNAME="0.0.0.0"

EXPOSE 3000

# Comando
CMD ["yarn", "dev"]