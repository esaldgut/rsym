# Manifest basado en documentación oficial AWS Copilot
# https://aws.github.io/copilot-cli/docs/manifest/lb-web-service/

name: nextjs-dev
type: Load Balanced Web Service

# Configuración HTTP con health check optimizado para Next.js dev
http:
  path: '/'
  healthcheck:
    path: '/api/health'              # Endpoint dedicado
    healthy_threshold: 3             # Checks exitosos para marcar healthy
    unhealthy_threshold: 2           # Default oficial
    interval: 30s                    # Default oficial
    timeout: 10s                     # Tiempo de espera razonable
    grace_period: 180s               # 3 minutos para yarn dev startup
    success_codes: '200'             # Solo 200 OK
  alias: 'yaan.com.mx'
  additional_aliases:
    - 'www.yaan.com.mx'
  certificate: 'arn:aws:acm:us-west-2:288761749126:certificate/777f93fa-5315-472e-9df3-94b41098ac4f'

# Imagen de desarrollo
image:
  build: Dockerfile.dev
  port: 3000

# Recursos escalados para performance con imagen grande
cpu: 2048        # 2 vCPUs - Escalamiento vertical para yarn dev + imagen 2.83GB
memory: 6144     # 6GB RAM - Necesario para imagen grande + hot reload + compilaciones

# Plataforma y configuración básica
platform: linux/x86_64
count: 2         # 2 instancias para distribución de carga y redundancia
exec: true       # Permitir copilot task exec para debugging

# Red
network:
  connect: true  # Service Connect para comunicación interna

# Variables de entorno para desarrollo
variables:
  NODE_ENV: development
  NEXT_TELEMETRY_DISABLED: 1
  PORT: 3000
  AWS_REGION: us-west-2
  HOSTNAME: "0.0.0.0"
  # Variables públicas - disponibles en tiempo de build y runtime
  NEXT_PUBLIC_BASE_URL: "https://yaan.com.mx"
  NEXT_PUBLIC_APP_SCHEME: "yaan"
  # MIT Payment Gateway
  MIT_ENVIRONMENT: sandbox
  MIT_BASE_URL: "https://sandbox.mitpaymentgateway.com"

# Secretos desde AWS Secrets Manager
# IMPORTANTE: Estos secretos deben crearse primero con scripts/setup-copilot-secrets.sh
secrets:
  # Secret para cifrado AES-256-GCM de URLs de booking (FASE 1)
  URL_ENCRYPTION_SECRET: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/URL_ENCRYPTION_SECRET
  # Secret para verificar HMAC SHA-256 de webhooks MIT (FASE 6)
  MIT_WEBHOOK_SECRET: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/MIT_WEBHOOK_SECRET
  # API Key para MIT Payment Gateway (FASE 6)
  MIT_API_KEY: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/MIT_API_KEY

# Logging habilitado
logging:
  enable_metadata: true

# Configuración específica por entorno
environments:
  dev:
    count: 1
    variables:
      LOG_LEVEL: debug
      NEXT_PUBLIC_ENV: development
      # MIT Sandbox para desarrollo
      MIT_ENVIRONMENT: sandbox
      MIT_BASE_URL: "https://sandbox.mitpaymentgateway.com"
  prod:
    count: 2
    variables:
      LOG_LEVEL: info
      NEXT_PUBLIC_ENV: production
      NODE_ENV: production
      # MIT Producción
      MIT_ENVIRONMENT: production
      MIT_BASE_URL: "https://api.mitpaymentgateway.com"